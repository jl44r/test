<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="-1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Internet hotspot - Log in</title>

    <!-- QR Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <link rel="stylesheet" href="css/style.css">

    <style>
        .btn-qr {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid rgba(43, 140, 255, 0.14);
            color: #2b8cff;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            width: 100%;
        }

        #reader {
            width: 300px;
            margin: 15px auto;
            display: none;
        }
    </style>
</head>

<body>

$(if chap-id)
<form name="sendin" action="$(link-login-only)" method="post" style="display:none">
    <input type="hidden" name="username" />
    <input type="hidden" name="password" />
    <input type="hidden" name="dst" value="$(link-orig)" />
    <input type="hidden" name="popup" value="true" />
</form>

<script src="/md5.js"></script>
<script>
function doLogin() {
    document.sendin.username.value = document.login.username.value;
    document.sendin.password.value =
        hexMD5('$(chap-id)' + document.login.username.value + '$(chap-challenge)');
    document.sendin.submit();
    return false;
}
</script>
$(endif)

<div class="ie-fixMinHeight">
    <div class="main">
        <div class="wrap animated fadeIn">

            <form name="login" action="$(link-login-only)" method="post"
                $(if chap-id) onSubmit="return doLogin()" $(endif)>

                <input type="hidden" name="dst" value="$(link-orig)" />
                <input type="hidden" name="popup" value="true" />

                <p class="info">
                    Scan QR code or enter username manually
                </p>

                <!-- USERNAME -->
                <label>
                    <img class="ico" src="img/user.svg" alt="#" />
                    <input id="username" name="username" type="text" placeholder="Username" />
                </label>

                <!-- SCAN BUTTON -->
                <button type="button" class="btn-qr" onclick="startScan()">
                    ðŸ“· Scan QR Code
                </button>

                <!-- QR CAMERA -->
                <div id="reader"></div>

                <!-- CONNECT BUTTON (NORMAL) -->
                <input type="submit" value="Connect" />

            </form>

            <p class="info bt">Powered by MikroTik RouterOS</p>
        </div>
    </div>
</div>

<script>
let html5QrCode;

function startScan() {
    const reader = document.getElementById("reader");
    reader.style.display = "block";

    html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
        { facingMode: "environment" },
        {
            fps: 10,
            qrbox: 250
        },
        qrCodeMessage => {
            document.getElementById("username").value = qrCodeMessage;

            html5QrCode.stop().then(() => {
                reader.style.display = "none";

                // AUTO LOGIN AFTER SCAN
                setTimeout(() => {
                    if (typeof doLogin === "function") {
                        doLogin(); // CHAP
                    } else {
                        document.login.submit(); // NO CHAP
                    }
                }, 300);
            });
        },
        errorMessage => {
            // ignore errors
        }
    );
}
</script>

</body>
</html>
