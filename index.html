<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="-1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Internet hotspot - Log in</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <!-- two other colors

<body class="lite">
<body class="dark">

-->

    $(if chap-id)
    <form name="sendin" action="$(link-login-only)" method="post" style="display:none">
        <input type="hidden" name="username" />
        <input type="hidden" name="password" />
        <input type="hidden" name="dst" value="$(link-orig)" />
        <input type="hidden" name="popup" value="true" />
    </form>

    <script src="/md5.js"></script>
    <script>
        function doLogin() {
            document.sendin.username.value = document.login.username.value;
            document.sendin.password.value = hexMD5('$(chap-id)' + document.login.username.value + '$(chap-challenge)');
            document.sendin.submit();
            return false;
        }

    </script>
    $(endif)
    <div class="ie-fixMinHeight">
        <div class="main">
            <div class="wrap animated fadeIn">
                <form name="login" action="$(link-login-only)" method="post" $(if chap-id) onSubmit="return doLogin()" $(endif)>
                    <input type="hidden" name="dst" value="$(link-orig)" />
                    <input type="hidden" name="popup" value="true" />
                    <svg class="logo" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 174 42">
                        <path fill="#fff" d="M7.32 13.66L0 41.74 3.12 41.74 9.49 15.94 9.58 15.94 15.01 41.74 18.22 41.74 36.86 16.34 36.95 16.34 30.02 41.74 33.18 41.74 40.4 13.66 35.73 13.66 17.23 38.87 11.99 13.66 7.32 13.66zM43.43 21.45L38.19 41.74 41.16 41.74 46.4 21.45 43.43 21.45zM50.68 21.45L45.5 41.74 48.47 41.74 50.36 34.39 55.55 30.77 62.02 41.74 65.27 41.74 57.91 29.28 69.43 21.45 65.46 21.45 51.21 31.36 51.12 31.28 53.66 21.45 50.68 21.45z" />
                        <path d="M71.18 21.45L65.94 41.74h3l2.74-10.62c1-3.81 3.82-7.39 9.16-7.47.56 0 1.13 0 1.7 0l.66-2.48c-.52 0-1.09 0-1.61 0-4.34 0-6.94 2-8.82 5h-.1l1.23-4.68zM103.8 28.8c0-5-4-7.94-9.63-7.94-8.69 0-13.59 6.37-13.59 13 0 5.07 3.44 8.45 9.72 8.45 9 0 13.5-6.68 13.5-13.53m-3 .52c0 4.72-3.44 10.93-9.95 10.93-5 0-7.32-2.68-7.32-6.61 0-4.76 3.59-10.7 10.1-10.7 4.77 0 7.17 2.6 7.17 6.38M132.33 21.43L134.26 13.66 105.19 13.66 103.27 21.45 112.59 21.45 112.59 21.45 122.99 21.45 122.99 21.45 132.33 21.43zM111.67 25.17L107.55 41.74 117.93 41.74 122.06 25.17 122.06 25.16 111.67 25.16 111.67 25.17zM134 25.17l-4.11 16.57h9.35l4.1-16.57zm10.28-3.73l1.94-7.78h-9.34l-2 7.79zM150.09 13.66L143.11 41.74 152.45 41.74 153.91 35.92 156.04 34.34 159.34 41.74 169.49 41.74 163.26 29.55 174.26 21.33 163.07 21.33 156.18 27.3 156.09 27.3 159.44 13.66 150.09 13.66zM47.45 0c1.14 7.93 5.39 12.74 14.07 13.14A10.69 10.69 0 0 1 47.45 0" fill="#fff" fill-rule="evenodd" />
                        <path d="M42.91,1.4c.1,0,.11,0,.12.11A16.55,16.55,0,0,0,48.26,13a16.6,16.6,0,0,0,12,4.66c-10,4-20.55-5.6-17.33-16.28" fill="#fff" fill-rule="evenodd" /></svg>


                    <p class="info $(if error)alert$(endif)">
                        $(if error == "")Please log in to use the internet hotspot service $(if trial == 'yes')<br />Free trial available, <a href="$(link-login-only)?dst=$(link-orig-esc)&amp;username=T-$(mac-esc)">click here</a>.$(endif)
                        $(endif)

                        $(if error)$(error)$(endif)
                    </p>
                    <label>
                        <img class="ico" src="img/user.svg" alt="#" />
                        <input name="username" type="text" value="" placeholder="Username" />
                    </label>

                     <a class="btn-qr" href="https://laksa19.github.io/myqr?dst=$(link-orig-esc)&mac=$(mac-esc)"
                       target="_blank" rel="noopener noreferrer" aria-label="Open QR code scanner (opens new tab)">
                       Scan QR / رمز QR
                    </a>
                    <!-- أضف هذا داخل <form> قبل زر <input type="submit"> -->
<!-- 1) طريقة مبسطة وموثوقة على كثير من الهواتف -->
<input type="file" id="qrFileInput" accept="image/*" capture="environment" style="display:none" />
<button type="button" class="btn-qr" id="openFileBtn"
    aria-label="Open back camera (file capture)">
    Scan QR (back camera) — ملف/صورة
</button>

<!-- 2) طريقة Live باستخدام getUserMedia (يفتح كاميرا حيّة، يفضل الخلفية) -->
<button type="button" class="btn-qr" id="openLiveBtn"
    aria-label="Open live camera (prefer back)">
    Scan QR (live camera)
</button>

<!-- حاوية الفيديو والالتقاط -->
<div id="scannerArea" style="display:none;margin-top:10px;">
    <video id="qrVideo" playsinline autoplay style="width:100%;max-height:360px;background:#000;"></video>
    <div style="margin-top:8px;">
        <button type="button" id="captureBtn" class="btn-qr">Capture</button>
        <button type="button" id="stopBtn" class="btn-qr secondary">Close</button>
    </div>
</div>

<script>
/* ---------- 1) ملف مع capture="environment" (فتح الكاميرا الخلفية على كثير من الأجهزة) ---------- */
document.getElementById('openFileBtn').addEventListener('click', function(){
    document.getElementById('qrFileInput').click();
});

document.getElementById('qrFileInput').addEventListener('change', async function(e){
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    // مثال: عرض الصورة في تبويب جديد (يمكن إرسالها لخادم للفحص أو تمريرها لمكتبة jsQR)
    const url = URL.createObjectURL(file);
    window.open(url, '_blank');
    // إذا أردت إرسالها إلى endpoint لمعالجتها:
    // const fd = new FormData(); fd.append('image', file);
    // await fetch('https://your-scan-endpoint.example/scan', { method:'POST', body: fd });
});

/* ---------- 2) Live getUserMedia مع محاولة لاختيار الكاميرا الخلفية ---------- */
const openLiveBtn = document.getElementById('openLiveBtn');
const scannerArea = document.getElementById('scannerArea');
const video = document.getElementById('qrVideo');
const captureBtn = document.getElementById('captureBtn');
const stopBtn = document.getElementById('stopBtn');
let streamRef = null;

async function startLiveScanner() {
    // الأفضل تجربة ideal ثم fallback
    const constraints = { video: { facingMode: { ideal: "environment" } } };
    try {
        // محاولة أولى: ترك المتصفح يختار الكاميرا الخلفية إن أمكن
        const s = await navigator.mediaDevices.getUserMedia(constraints);
        streamRef = s;
        video.srcObject = s;
        scannerArea.style.display = 'block';
        return;
    } catch (err) {
        console.warn('getUserMedia with facingMode failed, trying enumerateDevices fallback:', err);
    }

    // محاولة بديلة: جلب الأجهزة واختيار deviceId لكاميرا تبدو "خلفية"
    try {
        // طلب إذن بسيط (بعض المتصفحات لا تعرض أسماء الأجهزة قبل الإذن)
        const s = await navigator.mediaDevices.getUserMedia({ video: true });
        streamRef = s;
        // بعد الإذن نستطيع قراءة labels
        const devices = await navigator.mediaDevices.enumerateDevices();
        // اغلاق الستريم الظرفي الآن (سوف نعيد فتح الجهاز المحدد)
        stopStream(streamRef);
        streamRef = null;

        // ابحث عن أول جهاز فيديو يحتوي اسماً يدل على back / rear / environment
        let preferred = devices.find(d => d.kind === 'videoinput' && /back|rear|environment/i.test(d.label));
        // إذا لم نجده اختر آخر جهاز كاميرا غالباً يكون الخلفية على الهواتف
        if(!preferred) {
            const vids = devices.filter(d => d.kind === 'videoinput');
            if(vids.length) preferred = vids[vids.length - 1];
        }

        if(preferred) {
            const s2 = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: preferred.deviceId } } });
            streamRef = s2;
            video.srcObject = s2;
            scannerArea.style.display = 'block';
        } else {
            // فشل إيجاد جهاز محدد — اعرض رسالة أو حاول الكاميرا الافتراضية
            const s3 = await navigator.mediaDevices.getUserMedia({ video: true });
            streamRef = s3;
            video.srcObject = s3;
            scannerArea.style.display = 'block';
        }
    } catch (err2) {
        console.error('Cannot access camera:', err2);
        alert('لا يمكن الوصول إلى الكاميرا على هذا الجهاز / في هذا المتصفح. قد يمنع captive portal الوصول أو المتصفح لا يدعم getUserMedia.');
    }
}

function stopStream(s) {
    if(!s) return;
    s.getTracks().forEach(t => t.stop());
}

openLiveBtn.addEventListener('click', () => {
    // افتح الماسح الحي (سيطلب تصريح الكاميرا)
    startLiveScanner();
});

stopBtn.addEventListener('click', () => {
    stopStream(streamRef);
    streamRef = null;
    video.srcObject = null;
    scannerArea.style.display = 'none';
});

// مثال بسيط لالتقاط فريم من الفيديو إلى canvas (يمكن بعد ذلك استخدام مكتبة jsQR لفحص QR)
captureBtn.addEventListener('click', () => {
    if(!video || !video.videoWidth) {
        alert('الكاميرا غير جاهزة بعد');
        return;
    }
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    // عرض الصورة الملتقطة في تبويب جديد
    canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        // هنا يمكنك إرسال الـ blob لمخدم أو تمريره إلى مكتبة jsQR لقراءة الرمز
    }, 'image/jpeg', 0.9);
});
</script>
                    

                    <input type="submit" value="Connect" />

                </form>
                <p class="info bt">Powered by MikroTik RouterOS</p>

            </div>
        </div>
    </div>
</body>

</html>


