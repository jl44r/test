<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="-1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Internet hotspot - Log in</title>
    <link rel="stylesheet" href="css/style.css">

    <style>
        /* تنسيقات بسيطة لمساحة الماسح والزر */
        .btn-qr {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid rgba(43, 140, 255, 0.14);
            color: #2b8cff;
            font-weight: 600;
            cursor: pointer;
            margin-top: 6px;
        }

        #scannerArea {
            display: none;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            position: relative;
        }

        #qrVideo {
            width: 100%;
            height: auto;
            display: block;
            background: #000;
        }

        #scannerMsg {
            margin-top: 6px;
            font-size: 13px;
            color: #666;
            text-align: center;
        }

        /* صندوق دليل المسح فوق الفيديو */
        #scanOverlay {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            box-shadow: inset 0 0 0 9999px rgba(0, 0, 0, 0.35);
        }

        #scanBox {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 70%;
            max-width: 360px;
            height: 38%;
            transform: translate(-50%, -50%);
            border: 2px dashed rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>

    <!-- CHAP hidden form (يظهر فقط إن كان CHAP مفعل) -->
    $(if chap-id)
    <form name="sendin" action="$(link-login-only)" method="post" style="display:none">
        <input type="hidden" name="username" />
        <input type="hidden" name="password" />
        <input type="hidden" name="dst" value="$(link-orig)" />
        <input type="hidden" name="popup" value="true" />
    </form>
    <script src="/md5.js"></script>
    $(endif)

    <div class="ie-fixMinHeight">
        <div class="main">
            <div class="wrap animated fadeIn">
                <form name="login" action="$(link-login-only)" method="post" $(if chap-id) onSubmit="return doLogin()" $(endif)>
                    <input type="hidden" name="dst" value="$(link-orig)" />
                    <input type="hidden" name="popup" value="true" />
                    <svg class="logo" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 174 42">
                        <path fill="#fff"
                            d="M7.32 13.66L0 41.74 3.12 41.74 9.49 15.94 9.58 15.94 15.01 41.74 18.22 41.74 36.86 16.34 36.95 16.34 30.02 41.74 33.18 41.74 40.4 13.66 35.73 13.66 17.23 38.87 11.99 13.66 7.32 13.66zM43.43 21.45L38.19 41.74 41.16 41.74 46.4 21.45 43.43 21.45zM50.68 21.45L45.5 41.74 48.47 41.74 50.36 34.39 55.55 30.77 62.02 41.74 65.27 41.74 57.91 29.28 69.43 21.45 65.46 21.45 51.21 31.36 51.12 31.28 53.66 21.45 50.68 21.45z" />
                        <path
                            d="M71.18 21.45L65.94 41.74h3l2.74-10.62c1-3.81 3.82-7.39 9.16-7.47.56 0 1.13 0 1.7 0l.66-2.48c-.52 0-1.09 0-1.61 0-4.34 0-6.94 2-8.82 5h-.1l1.23-4.68zM103.8 28.8c0-5-4-7.94-9.63-7.94-8.69 0-13.59 6.37-13.59 13 0 5.07 3.44 8.45 9.72 8.45 9 0 13.5-6.68 13.5-13.53m-3 .52c0 4.72-3.44 10.93-9.95 10.93-5 0-7.32-2.68-7.32-6.61 0-4.76 3.59-10.7 10.1-10.7 4.77 0 7.17 2.6 7.17 6.38M132.33 21.43L134.26 13.66 105.19 13.66 103.27 21.45 112.59 21.45 112.59 21.45 122.99 21.45 122.99 21.45 132.33 21.43zM111.67 25.17L107.55 41.74 117.93 41.74 122.06 25.17 122.06 25.16 111.67 25.16 111.67 25.17zM134 25.17l-4.11 16.57h9.35l4.1-16.57zm10.28-3.73l1.94-7.78h-9.34l-2 7.79zM150.09 13.66L143.11 41.74 152.45 41.74 153.91 35.92 156.04 34.34 159.34 41.74 169.49 41.74 163.26 29.55 174.26 21.33 163.07 21.33 156.18 27.3 156.09 27.3 159.44 13.66 150.09 13.66zM47.45 0c1.14 7.93 5.39 12.74 14.07 13.14A10.69 10.69 0 0 1 47.45 0"
                            fill="#fff" fill-rule="evenodd" />
                        <path
                            d="M42.91,1.4c.1,0,.11,0,.12.11A16.55,16.55,0,0,0,48.26,13a16.6,16.6,0,0,0,12,4.66c-10,4-20.55-5.6-17.33-16.28"
                            fill="#fff" fill-rule="evenodd" />
                    </svg>

                    <p class="info $(if error)alert$(endif)">
                        $(if error == "")Please log in to use the internet hotspot service $(if trial ==
                        'yes')<br />Free trial available, <a
                            href="$(link-login-only)?dst=$(link-orig-esc)&amp;username=T-$(mac-esc)">click
                            here</a>.$(endif)
                        $(endif)

                        $(if error)$(error)$(endif)
                    </p>
                    <label>
                        <img class="ico" src="img/user.svg" alt="#" />
                        <input name="username" type="text" value="" placeholder="Username" />
                    </label>

                    <!-- زر يفتح الماسح ويطلب الكاميرا الخلفية -->
                    <button type="button" class="btn-qr" id="openScannerBtn" aria-label="Open back camera scanner">
                        Scan QR (Back Camera)
                    </button>

                    <!-- fallback: input ملف يستخدم capture="environment" -->
                    <input type="file" id="qrFileInput" accept="image/*" capture="environment" style="display:none" />

                    <!-- منطقة عرض الماسح الحي -->
                    <div id="scannerArea">
                        <video id="qrVideo" playsinline autoplay></video>
                        <div id="scanOverlay">
                            <div id="scanBox"></div>
                        </div>
                        <div id="scannerMsg">Ready to scan...</div>
                    </div>

                    <input type="submit" value="Connect" />
                </form>
                <p class="info bt">Powered by MikroTik RouterOS</p>

            </div>
        </div>
    </div>

    <!-- مكتبة jsQR لقراءة QR -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script>
        // تعريف متغيرات CHAP (تُستبدل من قِبل RouterOS إن وُجدت)
        var CHAP_EXISTS = false;
        var CHAP_ID = '';
        var CHAP_CHALLENGE = '';
        $(if chap-id)
        CHAP_EXISTS = true;
        CHAP_ID = '$(chap-id)';
        CHAP_CHALLENGE = '$(chap-challenge)';
        $(endif)

        // عناصر DOM
        const openScannerBtn = document.getElementById('openScannerBtn');
        const qrFileInput = document.getElementById('qrFileInput');
        const scannerArea = document.getElementById('scannerArea');
        const qrVideo = document.getElementById('qrVideo');
        const scannerMsg = document.getElementById('scannerMsg');

        let stream = null;
        let scanning = false;
        let rafId = null;

        // تأكد من ربط الأحداث بعد تحميل DOM
        window.addEventListener('DOMContentLoaded', () => {
            if (!openScannerBtn) return;

            openScannerBtn.addEventListener('click', async () => {
                scannerMsg.textContent = 'Requesting back camera...';

                if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) {
                    alert('getUserMedia غير متوفّر في هذا المتصفح/السياق. سيتم فتح اختيار صورة كبديل.');
                    qrFileInput.click();
                    return;
                }

                // محاولة 1: exact facingMode
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } }, audio: false });
                    startStream(stream);
                    return;
                } catch (err) {
                    console.debug('exact facingMode failed', err);
                }

                // محاولة 2: ideal facingMode
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio: false });
                    startStream(stream);
                    return;
                } catch (err) {
                    console.debug('ideal facingMode failed', err);
                }

                // محاولة 3: enumerateDevices لاختيار deviceId يبدو خلفي
                try {
                    // بعض المتصفحات تحتاج إذن مؤقت لرؤية تسميات الأجهزة
                    const temp = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    temp.getTracks().forEach(t => t.stop());

                    const videoDevices = devices.filter(d => d.kind === 'videoinput');
                    let preferred = videoDevices.find(d => /back|rear|environment|wide|ultrawide/i.test(d.label));
                    if (!preferred && videoDevices.length) preferred = videoDevices[videoDevices.length - 1];

                    if (preferred) {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: preferred.deviceId } }, audio: false });
                        startStream(stream);
                        return;
                    }
                } catch (err) {
                    console.debug('enumerateDevices fallback failed', err);
                }

                // آخر حل: افتح ملف (سيشغّل تطبيق الكاميرا غالباً على الهاتف)
                alert('تعذّر الوصول للكاميرا الخلفية تلقائياً. سيتم فتح اختيار ملف كبديل.');
                qrFileInput.click();
            });

            // معالجة صورة من ملف كخطة احتياطية
            qrFileInput.addEventListener('change', async (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    try {
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'attemptBoth' });
                        if (code && code.data) {
                            handleQRCode(code.data.trim());
                        } else {
                            alert('لم يتم قراءة رمز QR من الصورة.');
                        }
                    } catch (ex) {
                        alert('خطأ عند معالجة الصورة: ' + (ex.message || ex));
                    }
                };
                img.onerror = () => alert('خطأ في تحميل الصورة.');
            });
        });

        // بدء البث من الستريم وإظهار الفيديو ثم بدء المسح
        function startStream(s) {
            stream = s;
            qrVideo.srcObject = stream;
            qrVideo.setAttribute('playsinline', 'true'); // مهم لأجهزة iOS
            qrVideo.play().catch(() => { /* ignore */ });
            scannerArea.style.display = 'block';
            scanning = true;
            scannerMsg.textContent = 'Scanning for QR...';
            scanLoop();
        }

        function stopScanner() {
            scanning = false;
            if (rafId) cancelAnimationFrame(rafId);
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            qrVideo.srcObject = null;
            scannerArea.style.display = 'none';
            scannerMsg.textContent = '';
        }

        function scanLoop() {
            if (!scanning) return;
            if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = qrVideo.videoWidth;
                canvas.height = qrVideo.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
                try {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'attemptBoth' });
                    if (code && code.data) {
                        stopScanner();
                        handleQRCode(code.data.trim());
                        return;
                    }
                } catch (e) {
                    console.warn('scan error', e);
                }
            }
            rafId = requestAnimationFrame(scanLoop);
        }

        // معالجة نص QR وتنفيذ تسجيل الدخول (username == password افتراضياً)
        function handleQRCode(qrText) {
            if (!qrText) {
                alert('الرمز فارغ.');
                return;
            }

            let username = qrText;
            let password = qrText;
            if (qrText.indexOf(':') !== -1) {
                const parts = qrText.split(':');
                username = parts[0];
                password = parts.slice(1).join(':');
            }

            // CHAP handling إذا كان موجوداً
            if (CHAP_EXISTS) {
                if (typeof hexMD5 === 'function') {
                    try {
                        document.sendin.username.value = username;
                        document.sendin.password.value = hexMD5(CHAP_ID + username + CHAP_CHALLENGE);
                        document.sendin.submit();
                        return;
                    } catch (err) {
                        console.warn('CHAP submit failed', err);
                    }
                } else {
                    alert('md5.js مطلوب لتسجيل الدخول عبر CHAP.');
                    return;
                }
            }

            // PAP / POST fallback: إنشاء فورم وإرساله
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '$(link-login-only)';
            form.style.display = 'none';

            const iUser = document.createElement('input');
            iUser.name = 'username';
            iUser.value = username;
            form.appendChild(iUser);

            const iPass = document.createElement('input');
            iPass.name = 'password';
            iPass.value = password;
            form.appendChild(iPass);

            const iDst = document.createElement('input');
            iDst.name = 'dst';
            iDst.value = '$(link-orig)';
            form.appendChild(iDst);

            const iPopup = document.createElement('input');
            iPopup.name = 'popup';
            iPopup.value = 'true';
            form.appendChild(iPopup);

            document.body.appendChild(form);
            form.submit();
        }

        // إيقاف الكاميرا عند مغادرة الصفحة
        window.addEventListener('pagehide', stopScanner);
        window.addEventListener('beforeunload', stopScanner);
    </script>
</body>

</html>
